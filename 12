# Check if Python is installed and usable
function Test-PythonInstalled {
    $cmd = Get-Command python -ErrorAction SilentlyContinue
    if ($cmd -and $cmd.Source -notmatch "windowsApps") {
        return $true
    }

    $cmd3 = Get-Command python3 -ErrorAction SilentlyContinue
    if ($cmd3 -and $cmd3.Source -notmatch "windowsApps") {
        return $true
    }

    return $false
}

# Begin setup
if (-not (Test-PythonInstalled)) {
    Write-Host "`n[SETUP] Python not found. Installing..."

    $pyVersion = "3.13.5"
    $pyUrl = "https://www.python.org/ftp/python/$pyVersion/python-$pyVersion-amd64.exe"
    $pyInstaller = "$PSScriptRoot\python-installer.exe"

    # Download the installer
    Write-Host "[INFO] Downloading Python $pyVersion..."
    Invoke-WebRequest $pyUrl -OutFile $pyInstaller

    # Install silently
    Write-Host "[INFO] Running silent installer..."
    Start-Process -FilePath $pyInstaller -ArgumentList "/quiet InstallAllUsers=1 PrependPath=1 Include_test=0" -Wait

    # Update PATH manually
    $env:PATH += ";C:\Program Files\Python313\Scripts;C:\Program Files\Python313"

    # Reload environment PATH from registry (optional but safer)
    $env:PATH = [System.Environment]::GetEnvironmentVariable("Path", [System.EnvironmentVariableTarget]::Machine)

    # Wait briefly for changes to register
    Start-Sleep -Seconds 3

    # Re-check installation
    if (-not (Test-PythonInstalled)) {
        Write-Host "[ERROR] Python not detected after installation."
        exit 15
    } else {
        Write-Host "[OK] Python installed successfully."
    }
} else {
    Write-Host "[OK] Python already installed."
}

# Show Python version and path
$pythonCmd = Get-Command python -ErrorAction SilentlyContinue
if ($pythonCmd -and $pythonCmd.Source -notmatch "windowsApps") {
    Write-Host "`n[INFO] Python path: $($pythonCmd.Source)"
    & $pythonCmd.Source --version
}
